#define TRIG_PIN 2
#define ECHO_PIN 3
#define PIEZO_PIN 12

// RGB LED 핀 정의 (공통 캐소드 기준)
#define RGB_RED_PIN 11
#define RGB_GREEN_PIN 10
#define RGB_BLUE_PIN 9

// 임계 거리 (30cm)
#define DIST_THRESHOLD 30

// RGB LED 색상 설정 함수
void setLEDColor(int red, int green, int blue) {
  analogWrite(RGB_RED_PIN, red);
  analogWrite(RGB_GREEN_PIN, green);
  analogWrite(RGB_BLUE_PIN, blue);
}

// 초음파 센서를 이용한 거리 측정 함수 (단위: cm)
long measureDistance() {
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);
  
  long duration = pulseIn(ECHO_PIN, HIGH);
  long distanceCM = duration * 0.034 / 2;  // 초당 340 m, 0.034 cm/us, 왕복이므로 2로 나눔
  return distanceCM;
}

void setup() {
  // 핀 모드 설정
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  pinMode(PIEZO_PIN, OUTPUT);
  pinMode(RGB_RED_PIN, OUTPUT);
  pinMode(RGB_GREEN_PIN, OUTPUT);
  pinMode(RGB_BLUE_PIN, OUTPUT);
  
  Serial.begin(9600);
  
  // 초기 상태: RGB LED를 초록색으로 설정
  setLEDColor(0, 255, 0);
}

void loop() {
  long distance = measureDistance();
  Serial.print("Distance: ");
  Serial.print(distance);
  Serial.println(" cm");
  
  // 차고 내 차량이 임계 거리(30cm) 이내로 들어왔을 경우
  if(distance > 0 && distance < DIST_THRESHOLD) {
    // LED를 빨간색으로 설정
    setLEDColor(255, 0, 0);
    
    // 피에조 스피커로 1000Hz 음을 3초간 출력
    tone(PIEZO_PIN, 1000);
    delay(3000);
    noTone(PIEZO_PIN);
    
    // 동작 후 LED를 다시 초록색으로 복원
    setLEDColor(0, 255, 0);
  }
  
  delay(100); // 안정적인 센서 값을 위해 잠깐 대기
}
